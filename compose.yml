version: '3.8'

services:
  web:
    build: .
    restart: always
    # 启动命令：先收集静态文件，然后启动 Gunicorn
    command: sh -c "python manage.py collectstatic --noinput && gunicorn project.wsgi:application --workers 4 --threads 4 --timeout 60 --bind 0.0.0.0:8000"
    image: volunteer-web:latest
    volumes:
      # === 核心修复 ===
      # 使用本地目录挂载，彻底解决样式找不到的问题
      - ./staticfiles:/app/staticfiles
      - media_volume:/app/media
      - ./:/app
    expose:
      - 8000
    environment:
      - DJANGO_SECRET_KEY=k9v2mZp5Lq8XyRn4Ws7Ab3Cd0Ef1GhJkLoIuQP123456789
      # 生产环境建议 False，如果再次遇到 500 错误可临时改为 True 查看报错
      - DJANGO_DEBUG=False
      # 允许的主机头，包含主域名、备用域名和本地测试域名
      - DJANGO_ALLOWED_HOSTS=sgzqsnxzyzst.top,www.sgzqsnxzyzst.top,sgzqsnxzyzst.xx.kg,origin.sgzqsnxzyzst.xx.kg,127.0.0.1,localhost,nginx
      
      # 数据库配置
      - DB_NAME=volunteer_platform_final
      - DB_USER=dedewo882
      - DB_PASS=11001100Asd
      - DB_HOST=pgm-uf6795490263rb7w.rwlb.rds.aliyuncs.com
      - DB_PORT=5432

  nginx:
    build: ./nginx
    restart: always
    image: volunteer-nginx:latest
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      # === 核心修复 ===
      # Nginx 读取同一个本地文件夹，确保能拿到 web 容器生成的文件
      - ./staticfiles:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      - web

  tunnel:
    image: cloudflare/cloudflared:latest
    restart: always
    # 使用最简命令，自动读取 Token，避免 flag 冲突
    command: tunnel run
    environment:
      # 请确保这里是你最新的 Tunnel Token (从 Cloudflare 后台复制的那一长串)
      - TUNNEL_TOKEN=eyJhIjoiNjc0ZTdkODdmN2RlYjcwMzkyMTViNDIxN2EzMTEyZWYiLCJ0IjoiYzMyOGMwYTQtYjZkMC00ZTRjLWE2MDYtYTEwYTU2NjJiODNlIiwicyI6IlpEaGpNbU5oTW1VdFpXRTNNQzAwTXprekxXRTFaVFF0WkRBME9XSTROalF3WXpZMyJ9
    depends_on:
      - nginx

volumes:
  # static_volume 已移除，改用本地挂载
  media_volume: