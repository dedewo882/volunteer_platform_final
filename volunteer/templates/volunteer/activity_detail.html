{% extends 'volunteer/base.html' %}
{% block content %}
<div class="bg-white p-5 rounded-4 shadow-sm">
  <h1 class="fw-bold text-dark mb-3">{{ activity.title }}</h1>
  
  {% if activity.start_date %}
    <p class="text-muted mb-4"><i class="bi bi-calendar-range text-primary"></i> 活动日期: {{ activity.start_date }} 至 {{ activity.end_date }}</p>
  {% endif %}
  
  <hr class="opacity-10">
  <h4 class="fw-bold text-secondary mb-3">活动详情</h4>
  <div class="fs-5 text-secondary lh-lg">{{ activity.description|safe }}</div>
  <hr class="opacity-10 my-4">
  
  <h4 class="fw-bold text-secondary mb-3">报名要求</h4>
  <ul class="list-group list-group-flush mb-4">
    <li class="list-group-item border-0 px-0 py-2">
        <i class="bi bi-clock-history text-success me-2"></i> 服务时长奖励: <span class="fw-bold">{{ activity.hours_reward }} 小时</span>
    </li>
    <li class="list-group-item border-0 px-0 py-2 {% if not reason_xp_ok %}text-danger{% endif %}">
      <i class="bi bi-lightning-fill text-warning me-2"></i> 经验值要求: {{ activity.min_xp }} - {{ activity.max_xp }} XP
      {% if not reason_xp_ok %}<span class="badge bg-danger ms-2">您的经验: {{ user_profile.total_xp }} XP (不符合)</span>{% endif %}
    </li>
    <li class="list-group-item border-0 px-0 py-2 {% if not reason_gender_ok %}text-danger{% endif %}">
      <i class="bi bi-gender-ambiguous text-info me-2"></i> 性别要求: {{ activity.gender_restriction }}
      {% if not reason_gender_ok %}<span class="badge bg-danger ms-2">您的性别: {{ user_profile.gender }} (不符合)</span>{% endif %}
    </li>
    <li class="list-group-item border-0 px-0 py-2 {% if not reason_grade_ok %}text-danger{% endif %}">
      <i class="bi bi-mortarboard-fill text-primary me-2"></i> 年级要求: {% for grade in activity.grade_restriction.all %}{{ grade.name }} {% empty %}无{% endfor %}
      {% if not reason_grade_ok %}<span class="badge bg-danger ms-2">您的年级: {{ user_profile.grade.name|default:"未设置" }} (不符合)</span>{% endif %}
    </li>
  </ul>
  
  <div class="card bg-light border-0 rounded-4 p-4">
      <h4 class="fw-bold text-dark mb-3">报名操作</h4>
      {% if messages %}
        {% for message in messages %}
          <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} rounded-3 border-0 shadow-sm">{{ message }}</div>
        {% endfor %}
      {% endif %}

      {% if is_registered %}
        <div class="d-flex align-items-center p-3 bg-white rounded-3 shadow-sm">
            <div class="flex-grow-1">
                <h5 class="mb-1 fw-bold text-primary"><i class="bi bi-info-circle-fill me-2"></i>您已报名</h5>
                <p class="mb-0 text-muted small">场次：{{ registered_session|default:"默认场次" }}</p>
            </div>
            <div>
                {% if registration_status == 'Approved' %}<span class="badge bg-success fs-6 px-3 py-2 rounded-pill">已批准</span>
                {% elif registration_status == 'Pending' %}<span class="badge bg-warning text-dark fs-6 px-3 py-2 rounded-pill">待审核</span>
                {% elif registration_status == 'Rejected' %}<span class="badge bg-danger fs-6 px-3 py-2 rounded-pill">已拒绝</span>{% endif %}
            </div>
        </div>
      {% elif is_full %}
        <button class="btn btn-secondary disabled w-100 py-3 rounded-pill fw-bold">名额已满</button>
      {% elif not can_register %}
        <button class="btn btn-danger disabled w-100 py-3 rounded-pill fw-bold">您不符合报名要求</button>
      {% else %}
        <form method="post">
            {% csrf_token %}
            <div class="mb-4">
                <label class="form-label fw-bold text-secondary">选择参加场次</label>
                {{ form.session }}
                <div class="form-text">请选择您要参加的具体时间段。</div>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label class="form-label text-secondary small">手机号</label>
                    <input type="text" name="phone_number" class="form-control rounded-pill bg-white" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label text-secondary small">班级</label>
                    <input type="text" name="class_name" class="form-control rounded-pill bg-white" value="{{ user_profile.class_name }}" required>
                </div>
                 <div class="col-12">
                    <label class="form-label text-secondary small">班主任姓名</label>
                    <input type="text" name="headteacher_name" class="form-control rounded-pill bg-white" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm">确认报名</button>
        </form>
      {% endif %}
      
      {% if activity.capacity > 0 %}
        <div class="mt-3">
            <div class="d-flex justify-content-between text-muted small mb-1">
                <span>报名进度</span>
                <span class="text-dark fw-bold">{{ registrations_count }} / {{ activity.capacity }}</span>
            </div>
            <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-primary" role="progressbar" style="width: {% widthratio registrations_count activity.capacity 100 %}%;"></div>
            </div>
        </div>
      {% endif %}
  </div>
</div>
{% endblock %}