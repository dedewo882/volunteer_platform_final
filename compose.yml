version: '3.8'

services:
  web:
    build: .
    # 生产环境建议：失败或重启后自动启动
    restart: always
    # 启动命令：收集静态文件 -> 启动应用
    command: sh -c "python manage.py collectstatic --noinput && gunicorn project.wsgi:application --workers 4 --threads 4 --bind 0.0.0.0:8000"
    image: volunteer-web:latest
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
      - ./:/app
    expose:
      - 8000
    environment:
      # 请确保这些信息与您的云服务器真实环境一致
      - DJANGO_SECRET_KEY=k9v2mZp5Lq8XyRn4Ws7Ab3Cd0Ef1GhJkLoIuQP123456789
      - DJANGO_DEBUG=False
      # 如果您的云服务器有公网IP，建议也加在这里，虽然隧道主要靠 hostname
      - DJANGO_ALLOWED_HOSTS=139.196.250.176,sgzqsnxzyzst.top,www.sgzqsnxzyzst.top,127.0.0.1,localhost,nginx
      
      # 数据库配置
      - DB_NAME=volunteer_platform_final
      - DB_USER=dedewo882
      - DB_PASS=11001100Asd
      - DB_HOST=pgm-uf6795490263rb7w.rwlb.rds.aliyuncs.com
      - DB_PORT=5432

  nginx:
    build: ./nginx
    restart: always
    image: volunteer-nginx:latest
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      - web

  tunnel:
    image: cloudflare/cloudflared:latest
    restart: always
    command: tunnel --no-autoupdate run
    environment:
      # 您的 Tunnel Token
      - TUNNEL_TOKEN=eyJhIjoiNjc0ZTdkODdmN2RlYjcwMzkyMTViNDIxN2EzMTEyZWYiLCJ0IjoiYmUzYjdjMTUtN2RkOS00YWY4LWFmOGYtMjQxOWZiZjYyZjE4IiwicyI6IllXWTFNVGc1TnpVdE1UVXdOaTAwWXpFd0xUZzFNR1l0T0RjeU1tVXlORE15TVROaSJ9
    depends_on:
      - nginx

volumes:
  static_volume:
  media_volume: